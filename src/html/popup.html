<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MultiLookup - ブラウザアクション</title>
<script src="../js/lib/jquery-1.4.2.min.js"></script>
<script src="../js/lib/jquery-ui-1.8.5.min.js"></script>
<script src="../js/keybinds.js"></script>
<script async>
var multilookup = chrome.extension.getBackgroundPage().multilookup;
var popup = {};
popup.lookup = {
    currentTab: null,
    siteinfo: null,
    entries: null,
    context: null,
    langs: [],
    types: [],
    sites: [],
    timeoutID: null,
    suggest: {
        delay: 300,
        minLength: 3,
        list: []
    },
    selector: {
        submit: "#lookup",
        lang: "#lookup-lang",
        type: "#lookup-type",
        site: "#lookup-site",
        context: "#lookup-context",
        enable_suggest: "#enable-suggest"
    },

    init: function() {
        var self = this;
        this.siteinfo = multilookup.siteinfo.getSiteinfo();
        this.entries = multilookup.config.getConfigByName("entries");
        keybinds.init();
        $.each(this.entries, function(i, id) {
            var v = self.siteinfo[id];
            var langs = v["src-lang"].split(" ");
            $.each(langs, function(i, v) {
                if ($.inArray(v, self.langs) === -1)
                    self.langs.push(v);
            });
            if ($.inArray(v["type"], self.types) === -1)
                if (v["type"])
                    self.types.push(v["type"]);
            self.sites.push(v);
        });

        $.each(self.langs, function(i, v) {
            var node = $("<option />").val(v).text(v);
            $(self.selector.lang).append(node);
        });

        $.each(self.types, function(i, v) {
            var node = $("<option />").val(v).text(v);
            $(self.selector.type).append(node);
        });

        $.each(self.sites, function(i, v) {
            var node = $("<option />").val(v["id"]).text(v["name"]);
            $(self.selector.site).append(node)
        });

        $(self.selector.submit).bind("submit", self.onSubmit);
        $(self.selector.lang+", "+self.selector.type).bind("change", self.onChange);
        $(self.selector.context).bind("keyup", self.onKeyup).focus();

        $("input, select").bind("change", function() {
            popup.cache.saveFormData();
        });

        this.showHistories();
    },

    getLangValue: function() {
        return $(this.selector.lang).val();
    },

    setLangValue: function(value) {
        if (value) {
            $(this.selector.lang).val(value);
        }
    },

    getTypeValue: function() {
        return $(this.selector.type).val();
    },

    setTypeValue: function(value) {
        if (value) {
            $(this.selector.type).val(value);
        }
    },

    getSiteIdValue: function() {
        return $(this.selector.site).val();
    },

    setSiteIdValue: function(value) {
        if (value) {
            $(this.selector.site).val(value);
        }
    },

    getContext: function() {
        return $(this.selector.context).val();
    },

    setContext: function(value) {
        if (value) {
            $(this.selector.context).val(value);
        }
    },

    enableSuggest: function() {
        return $(this.selector.enable_suggest).is(":checked");
    },

    checkEnableSuggest: function(bool) {
        var node = $(this.selector.enable_suggest);
        if (bool) {
            node.attr("checked", "checked");
        } else {
            node.removeAttr("checked");
        }
    },

    onSubmit: function() {
        var self = popup.lookup;
        var lang = self.getLangValue();
        var type = self.getTypeValue();
        var id = self.getSiteIdValue();
        var text = self.getContext();
        if (!$.trim(text)) { return false; }
        multilookup.management.lookupShowResult(text, id, self.currentTab);
        return false;
    },

    onChange: function() {
        var self = popup.lookup;
        var lang = self.getLangValue();
        var type = self.getTypeValue();
        self.setSiteList(lang, type);
    },

    onKeyup: function() {
        var self = popup.lookup;
        var context = $(this).val();
        if ((context.length <= 3) || (context == self.context) || (!self.enableSuggest())) return;
        self.context = context;
        if (self.timeoutID != null) {
            window.clearTimeout(self.timeoutID);
            self.timeoutID = null;
        }
        self.timeoutID = window.setTimeout(function() {
            self.getSuggestList(context, function(list) {
                $(self.selector.context).unbind("autocomplete");
                self.showSuggest(list);
                $(self.selector.context).keydown();
            });
        }, self.suggest.delay);
    },

    getSuggestList: function(context, callback) {
        var self = popup.lookup;
        multilookup.suggest.getList(context, function(list) {
            self.suggest.list = [];
            $.each(list[1], function(i, v) {
                self.suggest.list.push(v[0]);
            });
            if (callback) {
                callback.call(this, self.suggest.list);
            }
        });
    },

    showSuggest: function(list) {
        var self = popup.lookup;
        $(self.selector.context).autocomplete({
            delay: 200,
            minLength: self.suggest.minLength,
            source: list,
            search: function(evt, ui) {
                keybinds.removeByKey("RET");
                keybinds.add(this, "RET", function(evt, keybind) {
                    $(this).autocomplete("close");
                    keybinds.remove(keybind);
                }, true);
            }
        });
    },

    setSiteList: function(lang, type) {
        var self = this;
        lang = lang || "";
        type = type || "";
        var sites = [];
        $("option:not([value=''])", $(self.selector.site)).remove();
        $.each(this.entries, function(i, id) {
            var v = self.siteinfo[id];
            if ((v["src-lang"].match(lang) !== null) && (v["type"].match(type) !== null))
                sites.push(v);
        });
        $.each(sites, function(i, v) {
            var node = $("<option />").val(v["id"]).text(v["name"]);
            $(self.selector.site).append(node);
        });
        this.sites = sites;
    },

    showHistories: function() {
        if (!multilookup.history.enabled()) return;
        var self = this;
        var list = $("<ul></ul>");
        var histories = multilookup.history.get();
        for (var i=0; i<histories.length; i++) {
            var li = $("<li></li>");
            var history = histories[i];
            li.text(history).addClass("history-item");
            li.bind("click", function() {
                $(self.selector.context).val($(this).text());
                $(this).submit();
            });
            list.append(li);
        }
        $("#history-list").append(list);
        $("#history").show();
    }
};

popup.cache = {
    data: null,
    getCachedData: function() {
        if (this.data !== null) {
            return this.data;
        }
        var data = {};
        var cache = localStorage["popup"];
        if (cache) {
            data = JSON.parse(cache);
            this.data = data;
        }
        return data;
    },

    setCachedDataToForm: function() {
        var cache = this.getCachedData();
        var lookup = popup.lookup, form;
        if (cache && cache["form"]) {
            form = cache["form"];
            lookup.setLangValue(form["lang"]);
            lookup.setTypeValue(form["type"]);
            lookup.setContext(form["context"]);
            lookup.checkEnableSuggest(form["enable_suggest"]);
            lookup.onChange();
            lookup.setSiteIdValue(form["site_id"]);
        }
    },

    saveFormData: function () {
        var data = this.getCachedData() || {};
        var lookup = popup.lookup, form;
        if (!data["form"]) { data["form"] = {}; }
        form = data["form"];
        form["lang"] = lookup.getLangValue();
        form["type"] = lookup.getTypeValue();
        form["site_id"] = lookup.getSiteIdValue();
        form["context"] = lookup.getContext();
        form["enable_suggest"] = lookup.enableSuggest();
        localStorage["popup"] = JSON.stringify(data);
    }
};

popup.option = {
    config: null,
    init: function() {
        this.config = multilookup.config.getConfig();
        this.load();
    },

    load: function() {
        var self = this;
        $("#option select").attr("value", function() {
            return self.config[this.name];
        }).bind("change", function() {
            var value = $(this).val();
            if (/^[0-9]*$/.test(value)) {
                value = parseInt(value);
            }
            var name = this.name;
            self.config[name] = value;
            self.save();
        });

        $("#option input[type='radio']").each(function() {
            var name = this.name;
            if (self.config[name] == $(this).val())
                $(this).attr("checked", true);
            $(this).bind("change", function() {
                var name = this.name;
                var value = $(this).val();
                if ((value == "0") || (value == "1")) {
                    value = (value == "1") ? true : false;
                }
                self.config[name] = value;
                self.save();
            });
        });

        $("#open_option_page").click(function() {
            multilookup.config.openOptionPage();
        });
    },

    save: function() {
        multilookup.config.save();
        multilookup.management.postConfigMessage();
    }
};

popup.changeTab = function(name) {
    if (!name) {
        return;
    }
    var tid = name + "-title";
    $(".content-title").each(function() {
        $(this).removeClass("content-title-active");
    });
    $("#"+tid).addClass("content-title-active");
    $(".content").hide();
    $("#"+name).show();
    var cache = popup.cache.getCachedData();
    cache["active_tab_name"] = name;
    popup.cache.saveFormData();
};

$(document).ready(function() {
    popup.lookup.init();
    popup.option.init();
    popup.cache.setCachedDataToForm();
    $(".content-title").click(function() {
        var name = this.id.replace("-title", "");
        popup.changeTab(name);
    });
    var cache = popup.cache.getCachedData();
    var tabname = cache["active_tab_name"] || "lookup";
    popup.changeTab(tabname);
});
</script>
<link rel="stylesheet" href="/css/popup.css" type="text/css" />
</head>
<body>
<h1>
    <span id="extension-title">MultiLookup</span>
    <span class="content-title content-title-active" id="lookup-title" >クイック検索</span>
    <span class="content-title" id="option-title">オプション</span>
</h1>
<form class="content" id="lookup" onsubmit="return false;">
    <div id="lookup-option">
        <label for="lookup-lang">言語</label>
        <select id="lookup-lang" name="lang">
            <option value="">--</option>
        </select>
        <label for="lookup-type">種別</label>
        <select id="lookup-type" name="lookup-type">
            <option value="">--</option>
        </select>
        <label for="lookup-site">サイト</label>
        <select id="lookup-site" name="lookup-site">
            <option value="">--</option>
        </select>
    </div>
    <input id="lookup-context" type="search" name="search" placeholder="入力してください" />
    <input type="submit" value="検索" />
    <input type="reset" value="リセット" />
    <div id="lookup-suboption">
        <input id="enable-suggest" type="checkbox" checked />
        <label for="enable-suggest">サジェストを有効にする</label>
    </div>
    <div id="history" style="display: none">
        <h2 class="history-title">履歴</h2>
        <div id="history-list"></div>
    </div>
</form>
<form class="content hide" id="option" onsubmit="return false;">
    <table>
        <tr>
            <th>表示位置</th>
            <td>
                <select id="result_position" class="option" name="result_position">
                    <option value="buttom">buttom</option>
                    <option value="left">left</option>
                    <option value="right">right</option>
                    <option value="top">top</option>
                </select>
            </td>
        </tr>
        <tr>
            <th>コンテキストメニュー</th>
            <td>
                <input type="radio" id="enable_context_menus" value="1" name="enable_context_menus" checked>
                <label for="enable_context_menus">有効にする</label>
                <input type="radio" id="disable_context_menus" value="0" name="enable_context_menus">
                <label for="disable_context_menus">無効にする</label>
            </td>
        </tr>
        <tr>
            <th>マウスホイールボタン</th>
            <td>
                <input type="radio" id="enable_middle_click_lookup" value="1" name="enable_middle_click_lookup" checked>
                <label for="enable_middle_click_lookup">有効にする</label>
                <input type="radio" id="disable_middle_click_lookup" value="0" name="enable_middle_click_lookup">
                <label for="disable_middle_click_lookup">無効にする</label>
            </td>
        </tr>
        <tr>
            <th>ダブルクリック</th>
            <td>
                <input type="radio" id="enable_dblclick_lookup" value="1" name="enable_dblclick_lookup">
                <label for="enable_dblclick_lookup">有効にする</label>
                <input type="radio" id="disable_dblclick_lookup" value="0" name="enable_dblclick_lookup" checked>
                <label for="disable_dblclick_lookup">無効にする</label>
            </td>
        </tr>
        <tr>
            <th>修飾キー</th>
            <td>
                <input type="radio" id="enable_modifier_key" value="1" name="enable_modifier_key" checked>
                <label for="enable_modifier_key">有効にする</label>
                <input type="radio" id="disable_modifier_key" value="0" name="enable_modifier_key">
                <label for="disable_modifier_key">修飾キーなし</label>
            </td>
        </tr>
        <tr>
            <th>オプションページ</th>
            <td><a id="open_option_page" href="#">オプションページを開く</a></td>
        </tr>
    </table>
</form>
</body>
</html>